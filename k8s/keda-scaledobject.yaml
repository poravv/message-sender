apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: sender-backend-scaledobject
  namespace: sender
spec:
  scaleTargetRef:
    name: sender-backend
  minReplicaCount: 0                    # Permitir escalar a 0
  maxReplicaCount: 2                    # Máximo 2 réplicas
  pollingInterval: 30                   # Revisar cada 30 segundos
  cooldownPeriod: 300                   # Esperar 5 minutos antes de escalar a 0
  idleReplicaCount: 0                   # Cuando no hay actividad, ir a 0
  triggers:
  # Escalar basado en peticiones HTTP (usando ingress-nginx metrics)
  - type: prometheus
    metadata:
      serverAddress: http://prometheus-server.monitoring.svc.cluster.local:80
      metricName: nginx_ingress_controller_requests
      threshold: '5'
      query: |
        sum(rate(nginx_ingress_controller_requests{namespace="sender",ingress="sender-ingress"}[2m]))
  # Escalar basado en CPU
  - type: cpu
    metricType: Utilization
    metadata:
      value: "70"
  # Escalar basado en memoria
  - type: memory
    metricType: Utilization
    metadata:
      value: "80"
---
# Fallback: Si KEDA no está instalado, usar HPA tradicional
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: sender-backend-hpa-fallback
  namespace: sender
  annotations:
    # Este HPA solo se activa si KEDA no está presente
    keda.sh/enabled: "false"
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: sender-backend
  minReplicas: 1
  maxReplicas: 2
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300   # 5 minutos de estabilización
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 100
        periodSeconds: 30
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
